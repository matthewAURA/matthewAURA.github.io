<html>
    <head>
        <title>Auckland Buses</title><meta name="viewport" content="initial-scale=1.0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <script src="js/jquery-1.9.1.min.js"></script>
        <script src="js/jquery.mobile-1.3.1.min.js"></script>
        <link rel="stylesheet" type="text/css" href="jquery.mobile-1.3.1.css" />
        <link rel="stylesheet" type="text/css" href="buses.css"/>
    </head>
    <body>
        <div data-role="header" data-position="fixed">
                <h1>Auckland Buses</h1>
        </div><!-- /header -->


        <script type="text/javascript" src="./js/DataConnection.js"></script>
        <script type="text/javascript" src="./js/Queue.js"></script>
        <script type="text/javascript" src="js/gps.js"></script>
        <script>
            var timetable = null;
            var nearby = null;
            var settings = null;
            var current;

            var apiKey = "a934bd17-826f-4fc4-aa5b-fb8be467a807";

            var routeFinder = {find:function(route){
                    for (i in this.routes){
                        if (this.routes[i].route_id == route){
                            return this.routes[i];
                        }
                    }
                    return null;
                }
            };

            function load(page){
                current.detach();
                current = page;
                $('#content').append(page);
            }

            var connection = new DataConnection(apiKey);
            var upcomingBuses = function(){
                load(timetable);
                $.mobile.loadingMessage = true;
                var stopID = $('#busstopinputfield').val();
                if (!stopID){
                    return;
                }else if (stopID.length != 4){
                    return;
                }
                //Lookup stop id
                connection.getStopCode(stopID,function(response){
                    console.log(response.response[0].stop_name);
                    var stopLat = response.response[0].stop_lat;
                    var stopLon = response.response[0].stop_lon;
                    var stopCode = response.response[0].stop_id;

                //Get upcoming trips through this stop
                connection.getRoutesAtStop(stopCode,function(response){
                    //Save the route info for later
                    if (response.status != "OK"){
                        return;
                    }
                    routeFinder.routes = response.response;

                    connection.getStopInfo(stopCode,function(trips){
                        if (trips.status =="OK"){
                            var now = new Date();
                            now = now.getHours()*3600+now.getMinutes()*60+now.getSeconds();
                            var arrivalTimes = {};
                            var requestQueue = new Queue();
                            var results = [];
                            for (i in trips.response){
                                var timeToDepature = parseInt(trips.response[i].arrival_time_seconds) - now;
                                if (timeToDepature < 30*60 && timeToDepature > 0){
                                    arrivalTimes[trips.response[i].trip_id] = trips.response[i].arrival_time;
                                    requestQueue.enqueue(trips.response[i]);
                                }
                            }
                            var numItems = requestQueue.getLength();
                            var calculateBuses = function(){
                                connection.getTripInfo(requestQueue.dequeue().trip_id,function(buses){
                                    if (buses.status == "OK"){
                                        var buslat = buses.response[0].latitude;
                                        var buslon = buses.response[0].longitude;
                                        results.push({routeName:routeFinder.find(buses.response[0].route_id).route_short_name,
                                                      headsign:buses.response[0].trip_headsign,
                                                      arrival:arrivalTimes[buses.response[0].trip_id],
                                                      distance:getDistanceFromLatLonInm(buslat,buslon,stopLat,stopLon)});
                                       if (results.length == numItems){
                                            displayData(results);
                                       }else{
                                           calculateBuses();
                                       }
                                    }else if (buses.status == "Too Many Requests"){
                                      console.log(buses);
                                    }
                                });
                            }
                            calculateBuses();

                        }
                    });

                });
            });
            };

            function displayData(data){
                data.sort(function(a,b){
                    return a.arrival > b.arrival;
                });
                $('#buseslist').empty();
                for (i in data){
                    console.log(data[i]);
                    appendToTimetable([data[i].routeName,data[i].headsign,data[i].arrival,data[i].distance]);
                }
                $.mobile.loadingMessage = false;
            }

            window.onload = function(){

                $('#timetableButton').click(function(event){
                    $(this).addClass('active').siblings().removeClass('active');
                    upcomingBuses();
                });

                $('#settingsButton').click(function(event){
                    $(this).addClass('active').siblings().removeClass('active');
                    load(settings);
                    var distance = localStorage.getItem("stopRadius");
                    if (distance){
                        $('#distanceSlider').val(distance);
                        $('#distanceSlider').slider('refresh');

                    }
                });



                $('#nearbyButton').click(function(event){
                   $(this).addClass('active').siblings().removeClass('active');
                    load(nearby);
                    var radius = localStorage.getItem("stopRadius")*1000;
                    if (!radius){
                        radius = 500;
                    }
                    $('#busesRadiusText').text("Bus stops Within: "+radius+"m");
                    var gps = new GPSController();
                    gps.getPosition(function(position){
                        connection.getNearbyStops(position.coords.latitude,position.coords.longitude,radius,function(result){
                            for (i in result.response){
                                var content = [];
                                content.push(result.response[i].stop_name);
                                console.log(result.response[i]);
                                content.push(result.response[i].stop_code);
                                content.push('');
                                appendToNearby(content);
                            }
                        });
                    });
                });

                $('#busstopinputfield').focusout(function(event){
                    upcomingBuses();
                });

                $('#busstopinputfield').keypress(function(event){
                   if (event.which == "13"){
                       $(this).focusout();
                   }
                });


                $('#distanceSlider').change(function(event){
                    localStorage.setItem("stopRadius",event.target.value);
                });

                $('#installButton').click(function(event){
                    var request = window.navigator.mozApps.install("http://192.168.1.104:1337/manifest.webapp");
                    request.onsuccess = function () {
                      // Save the App object that is returned
                      var appRecord = this.result;
                      alert('Installation successful!');
                    };
                    request.onerror = function () {
                      // Display the error information from the DOMError object
                      alert('Install failed, error: ' + this.error.name);
                    };
                });

                timetable = $('#timetable').detach();
                nearby = $('#nearby').detach();
                settings = $('#settings').detach();

                current = timetable;
                $('#content').append(timetable);



            }
            $.mobile.loadingMessage = false;

            function appendToNearby(content){
                $("#nearbyList").append(' <li class="ui-btn ui-li ui-btn-up-d"><div class="ul-btn-inner row"><p class="ul-li-heading">'+ content[0] + '</p><p class="ul-li-heading">' +content[1]+ '</p><p class="ul-li-heading">' +content[2]+'</p></div></li>');
            }

            function appendToTimetable(content){
                $("#buseslist   ").append(' <li class="ui-btn ui-li ui-btn-up-d"><div class="ul-btn-inner row"><p class="ul-li-heading">'+ content[0] + '</p><p class="ul-li-heading">' +content[1]+ '</p><p class="ul-li-heading">' +content[2]+'</p></div></li>');

                //$("#").append
                // <li class="ui-btn ui-li ui-btn-up-d"><div class="ul-btn-inner"><p class="ul-li-heading">Test</p></div></li>
            }

            function selectMenuItem(){

            }

            function getDistanceFromLatLonInm(lat1,lon1,lat2,lon2) {
              var R = 6374447; // Radius of the earth in mm
              var dLat = deg2rad(lat2-lat1);  // deg2rad below
              var dLon = deg2rad(lon2-lon1);
              var a =
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2)
                ;
              var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              var d = R * c; // Distance in km
              return Math.floor(d);
            }

            function deg2rad(deg) {
              return deg * (Math.PI/180)
            }

        </script>

        <div class="content" id='content'>
            <div class="timetable" id='timetable'>
              <div class="busstopinput">
              <input class="busstopinput" id="busstopinputfield" placeholder="Enter A Stop Code Here"/>

            </div>
            <ul data-role="listview" id="buseslist" data-inset="true">

            </ul>
            </div>
            <div class="timetable" id='nearby'>
                <h2 class='ui-body' id="busesRadiusText">Buses Within: ##km</h2>
                <ul data-role="listview" id="nearbyList" data-inset="true">
            </div>
            <div class="ui-body" id='settings'>
                <h2 class='control'>Settings</h2>
                <label for="distanceSlider">Maximum Distance of nearby stops (km)</label>
                <input type="range" name="slider" id="distanceSlider" value="0.5" min="0.5" max="5" step="0.5"  />
                <a href="#" data-role="button" id="installButton">Install this app on Firefox OS</a>
            </div>
        </div>
        <div data-role="footer" data-position="fixed">
            <div data-role="navbar">
        <ul>
        <li><a href="#stops" id="timetableButton" data-icon="arrow-d" class="ui-btn-active ui-state-persist">By Stop</a></li>
        <li><a href="#nearby" id="nearbyButton" data-icon="arrow-d">Nearby Stops</a></li>
        <li><a href="#settings" id="settingsButton" data-icon="gear">Settings</a></li>
      </ul>
    </div>
        </div>
    </body>
</html>
